name: "Continuous Deployment to Cloudflare Pages"
description: "Deploy to Cloudflare Pages"

inputs:
  cloudflare_api_token:
    description: "Cloudflare API Token"
    required: true
  repository:
    description: 'The GitHub repository to deploy, in the format "organization/repository"'
    required: true
  production_branch:
    description: "Production Branch"
    required: true
  output_directory:
    description: "Output Directory"
    required: true
  current_branch:
    description: "Compare if not production branch for preview deploys"
    required: true
  pull_request_number:
    description: "Pull request number for posting the deployment link"
    required: true
  commit_sha:
    description: "Commit SHA for posting the deployment link"
    required: false
  env_vars:
    description: "Environment variables in JSON format"
    required: false

runs:
  using: "composite"
  steps:

    - name: Check for pull_request_number or commit_sha
      shell: bash
      run: |
        if [ -z "${{ inputs.pull_request_number }}" ] && [ -z "${{ inputs.commit_sha }}" ]; then
          echo "Error: Either pull_request_number or commit_sha must be provided."
          exit 1
        fi

    - name: Set environment variables
      shell: bash
      run: |
        env_vars="${{ inputs.env_vars }}"
        for key in $(echo $env_vars | jq -r 'keys[]'); do
          value=$(echo $env_vars | jq -r --arg key "$key" '.[$key]')
          echo "Setting environment variable $key"
          echo "export $key='$value'" >> $GITHUB_ENV
        done

    - name: Deploy to Cloudflare
      shell: bash
      env:
        CLOUDFLARE_API_TOKEN: ${{ inputs.cloudflare_api_token }}
      run: bash ../../_actions/ubiquity/cloudflare-deploy-action/main/.github/cloudflare-deploy.sh "${{ inputs.repository }}" "${{ inputs.production_branch }}" "${{ inputs.output_directory }}" "${{ inputs.current_branch }}"
      # run: bash .github/cloudflare-deploy.sh "${{ inputs.repository }}" "${{ inputs.production_branch }}" "${{ inputs.output_directory }}" "${{ inputs.current_branch }}"

    - name: Post Deployment on Pull Request or Commit
      shell: bash
      run: |
        cd ../../_actions/ubiquity/cloudflare-deploy-action/main
        yarn add tsx -D
        yarn tsx src/post-deployment.ts --deployment_output "${{ env.DEPLOYMENT_OUTPUT }}" --repository "${{ inputs.repository }}" --pull_request_number "${{ inputs.pull_request_number }}" --commit_sha "${{ inputs.commit_sha }}"
